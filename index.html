<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Noodhulp App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="top-nav">
    <div class="nav-left">
        <select id="languageSelect" class="btn-lang" onchange="changeLanguage(this.value)">
            <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
            <option value="en">ğŸ‡¬ğŸ‡§ English</option>
            <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
            <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
            <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        </select>
        <a href="quiz.html" class="btn-top btn-trainen" data-i18n="train">Trainen</a>
    </div>
    <img src="images/logo.png" alt="Noodhulp App Logo" class="app-logo">
    <div class="nav-right">
        <a href="tel:112" class="btn-top btn-112" data-i18n="call112">ğŸ“ 112</a>
        <button class="info-btn" onclick="showInfo()" data-i18n="info">â„¹ï¸</button>
    </div>
</nav>

<nav class="bottom-nav">
    <a href="index.html" class="btn-top nav-item active">

        <span class="nav-text" data-i18n="home">Home</span>
    </a>
    <button class="icon-btn" onclick="toggleFlashlight()">
        <span class="nav-icon">ğŸ”¦</span>
        <span class="nav-text" data-i18n="flashlight">Zaklamp</span>
    </button>
    <button class="icon-btn" onclick="toggleDarkMode()">
        <span class="nav-icon">ğŸŒ“</span>
        <span class="nav-text" data-i18n="darkmode">Donker Modus</span>
    </button>
    <a href="kaart.html" class="btn-top nav-item">
        <span class="nav-text" data-i18n="aedmap">AED Kaart</span>
    </a>
</nav>

<main class="main-content">
    <section class="hero-actions">
        <a href="slachtoffer.html" class="card card-victim">
            <span class="card-icon">ğŸ©¹</span>
            <div class="card-text">
                <h2 data-i18n="victim">Slachtofferhulp</h2>
                <p data-i18n="victim_p">Eerste hulp verlenen</p>
            </div>
        </a>
        <a href="coÃ¶rdineren-hulp.html" class="card card-coord">
            <span class="card-icon">ğŸ“£</span>
            <div class="card-text">
                <h2 data-i18n="coord">CoÃ¶rdineren</h2>
                <p data-i18n="coord_p">Leid de hulpverlening</p>
            </div>
        </a>
        <div class="card card-location">
            <span class="card-icon">ğŸ“</span>
            <div class="card-text">
                <h2 data-i18n="mylocation">Mijn Locatie</h2>
                <p id="location-status" data-i18n="loc_fetching">Locatie ophalen...</p>
                <div id="location-details" style="font-size: 0.9rem; margin-top: 8px; color: #666;"></div>
            </div>
        </div>
        <a href="quiz.html" class="card card-quiz">
            <span class="card-icon">â“</span>
            <div class="card-text">
                <h2 data-i18n="quiz">Trainen</h2>
                <p data-i18n="quiz_p">Test je kennis</p>
            </div>
        </a>
        <a href="ehbo-gids.html" class="card card-guide">
            <span class="card-icon">ğŸ“–</span>
            <div class="card-text">
                <h2 data-i18n="guide">EHBO Gids</h2>
                <p data-i18n="guide_p">Hulpverlening stap voor stap</p>
            </div>
        </a>
        <a href="kaart.html" class="card card-map">
            <span class="card-icon">ğŸ—ºï¸</span>
            <div class="card-text">
                <h2 data-i18n="aedmap">AED Kaart</h2>
                <p data-i18n="aed_p">Vind een AED in de buurt</p>
            </div>
        </a>
    </section>
</main>

<script>
    // Locatie functionaliteit
    async function getReverseGeocode(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
            const data = await response.json();
            return data.address;
        } catch (error) {
            console.error('Reverse geocoding error:', error);
            return null;
        }
    }
    
    // Huidige taal en vertalingen
    let currentLang = localStorage.getItem('language') || 'nl';

    const translations = {
        nl: {
            train: 'Trainen',
            call112: 'ğŸ“ 112',
            home: 'Home',
            flashlight: 'Zaklamp',
            darkmode: 'Donker',
            aedmap: 'AED Kaart',
            victim: 'Slachtofferhulp',
            victim_p: 'Eerste hulp verlenen',
            coord: 'CoÃ¶rdineren',
            coord_p: 'Leid de hulpverlening',
            mylocation: 'Mijn Locatie',
            loc_fetching: 'Locatie ophalen...',
            loc_found: 'âœ“ Locatie gevonden',
            loc_unavailable: 'âœ— Locatie niet beschikbaar',
            loc_not_supported: 'Geolocation niet ondersteund',
            loc_permission: 'Geef toestemming voor locatie toegang',
            quiz: 'Trainen',
            quiz_p: 'Test je kennis',
            guide: 'EHBO Gids',
            guide_p: 'Hulpverlening stap voor stap',
            aed_p: 'Vind een AED in de buurt',
            infoTitle: 'Noodhulp App â€” versie 1.0',
            infoBody: 'Gebruik deze app voor EHBO snelhulp en navigatie.',
            info: 'â„¹ï¸'
        },
        en: {
            train: 'Training',
            call112: 'ğŸ“ 112',
            home: 'Home',
            flashlight: 'Flashlight',
            darkmode: 'Dark mode',
            aedmap: 'AED Map',
            victim: 'Victim Aid',
            victim_p: 'Provide first aid',
            coord: 'Coordinate',
            coord_p: 'Lead the response',
            mylocation: 'My Location',
            loc_fetching: 'Getting location...',
            loc_found: 'âœ“ Location found',
            loc_unavailable: 'âœ— Location unavailable',
            loc_not_supported: 'Geolocation not supported',
            loc_permission: 'Allow location access',
            quiz: 'Train',
            quiz_p: 'Test your knowledge',
            guide: 'First Aid Guide',
            guide_p: 'Step-by-step assistance',
            aed_p: 'Find an AED nearby',
            infoTitle: 'Emergency App â€” v1.0',
            infoBody: 'Use this app for quick first aid and navigation.',
            info: 'â„¹ï¸'
        },
        de: {
            train: 'Training',
            call112: 'ğŸ“ 112',
            home: 'Start',
            flashlight: 'Taschenlampe',
            darkmode: 'Nachtmodus',
            aedmap: 'AED Karte',
            victim: 'Opferhilfe',
            victim_p: 'Erste Hilfe leisten',
            coord: 'Koordinieren',
            coord_p: 'Leiten der Hilfeleistung',
            mylocation: 'Mein Standort',
            loc_fetching: 'Standort wordt opgehaald...',
            loc_found: 'âœ“ Standort gefunden',
            loc_unavailable: 'âœ— Standort nicht verfÃ¼gbar',
            loc_not_supported: 'Geolocation nicht unterstÃ¼tzt',
            loc_permission: 'Erlauben Sie den Standortzugriff',
            quiz: 'Ãœben',
            quiz_p: 'Teste dein Wissen',
            guide: 'Erste-Hilfe Anleitung',
            guide_p: 'Schritt fÃ¼r Schritt Hilfe',
            aed_p: 'Finde ein AED in der NÃ¤he',
            infoTitle: 'Notfall-App â€” v1.0',
            infoBody: 'Verwenden Sie diese App fÃ¼r Erste Hilfe und Navigation.',
            info: 'â„¹ï¸'
        },
        fr: {
            train: 'EntraÃ®nement',
            call112: 'ğŸ“ 112',
            home: 'Accueil',
            flashlight: 'Lampe de poche',
            darkmode: 'Mode sombre',
            aedmap: 'Carte AED',
            victim: 'Aide victime',
            victim_p: 'Fournir les premiers secours',
            coord: 'Coordonner',
            coord_p: 'Diriger lâ€™intervention',
            mylocation: 'Ma position',
            loc_fetching: 'RÃ©cupÃ©ration de la position...',
            loc_found: 'âœ“ Position trouvÃ©e',
            loc_unavailable: 'âœ— Position non disponible',
            loc_not_supported: 'GÃ©olocalisation non prise en charge',
            loc_permission: 'Autorisez lâ€™accÃ¨s Ã  la position',
            quiz: 'Sâ€™entraÃ®ner',
            quiz_p: 'Testez vos connaissances',
            guide: 'Guide de premiers secours',
            guide_p: 'Assistance Ã©tape par Ã©tape',
            aed_p: 'Trouvez un DAE Ã  proximitÃ©',
            infoTitle: 'Application dâ€™urgence â€” v1.0',
            infoBody: 'Utilisez cette application pour les premiers secours et la navigation.',
            info: 'â„¹ï¸'
        },
        es: {
            train: 'Entrenamiento',
            call112: 'ğŸ“ 112',
            home: 'Inicio',
            flashlight: 'Linterna',
            darkmode: 'Modo oscuro',
            aedmap: 'Mapa AED',
            victim: 'Ayuda a la vÃ­ctima',
            victim_p: 'Proporcionar primeros auxilios',
            coord: 'Coordinar',
            coord_p: 'Dirigir la respuesta',
            mylocation: 'Mi ubicaciÃ³n',
            loc_fetching: 'Obteniendo ubicaciÃ³n...',
            loc_found: 'âœ“ UbicaciÃ³n encontrada',
            loc_unavailable: 'âœ— UbicaciÃ³n no disponible',
            loc_not_supported: 'GeolocalizaciÃ³n no compatible',
            loc_permission: 'Permita el acceso a la ubicaciÃ³n',
            quiz: 'Practicar',
            quiz_p: 'Pon a prueba tus conocimientos',
            guide: 'GuÃ­a de primeros auxilios',
            guide_p: 'Asistencia paso a paso',
            aed_p: 'Encuentra un DEA cercano',
            infoTitle: 'App de emergencia â€” v1.0',
            infoBody: 'Usa esta app para primeros auxilios y navegaciÃ³n.',
            info: 'â„¹ï¸'
        }
    };

    function applyTranslations(lang) {
        const map = translations[lang] || translations['nl'];
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (map[key]) {
                el.textContent = map[key];
            }
        });
    }

    function requestLocationPermission() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Update de locatie informatie
                    document.getElementById('location-status').textContent = (translations[currentLang] && translations[currentLang]['loc_found']) ? translations[currentLang]['loc_found'] : 'âœ“ Locatie gevonden';
                    document.getElementById('location-details').innerHTML = (translations[currentLang] && translations[currentLang]['loc_fetching']) ? translations[currentLang]['loc_fetching'] : 'Adres ophalen...';
                    
                    // Haal adres informatie op
                    const address = await getReverseGeocode(lat, lon);
                    
                    if (address) {
                        const street = address.road || address.footway || '';
                        const houseNumber = address.house_number || '';
                        const city = address.city || address.town || address.village || '';
                        
                        let addressLine = '';
                        if (street && houseNumber) {
                            addressLine = `${street} ${houseNumber}`;
                        } else if (street) {
                            addressLine = street;
                        }
                        
                        document.getElementById('location-details').innerHTML = 
                            `${addressLine}<br>${city}`;
                    } else {
                        document.getElementById('location-details').innerHTML = 
                            `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    }
                },
                function(error) {
                    document.getElementById('location-status').textContent = (translations[currentLang] && translations[currentLang]['loc_unavailable']) ? translations[currentLang]['loc_unavailable'] : 'âœ— Locatie niet beschikbaar';
                    document.getElementById('location-details').textContent = (translations[currentLang] && translations[currentLang]['loc_permission']) ? translations[currentLang]['loc_permission'] : 'Geef toestemming voor locatie toegang';
                }
            );
        } else {
                document.getElementById('location-status').textContent = (translations[currentLang] && translations[currentLang]['loc_not_supported']) ? translations[currentLang]['loc_not_supported'] : 'Geolocation niet ondersteund';
        }
    }
    
    // Vraag om locatie toestemming wanneer de pagina laadt
    window.addEventListener('load', function() {
        requestLocationPermission();
    });
    
    // Herstel dark mode instellingen
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
    if (localStorage.getItem('flashlight') === 'true') {
        document.body.style.filter = 'invert(1)';
    }

    // Herstel taal voorkeur en pas vertalingen toe
    const savedLang = localStorage.getItem('language') || currentLang;
    currentLang = savedLang;
    applyTranslations(currentLang);
    window.addEventListener('load', function() {
        const langSelect = document.getElementById('languageSelect');
        if (langSelect) langSelect.value = currentLang;
    });

    function changeLanguage(code) {
        localStorage.setItem('language', code);
        currentLang = code;
        applyTranslations(code);
    }

    function showInfo() {
        const map = translations[currentLang] || translations['nl'];
        alert(map.infoTitle + "\n" + map.infoBody);
    }

    function toggleDarkMode() { 
        document.body.classList.toggle("dark-mode");
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }
    
    // Zaklamp variabele
    let flashlightStream = null;
    let flashlightTrack = null;
    
    async function toggleFlashlight() { 
        try {
            // Check browser support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Zaklamp niet ondersteund op deze browser.');
                return;
            }

            // Als zaklamp al aan staat, zet uit
            if (flashlightTrack) {
                try {
                    await flashlightTrack.applyConstraints({ advanced: [{ torch: false }] });
                    flashlightTrack.stop();
                    flashlightStream.getTracks().forEach(track => track.stop());
                    flashlightTrack = null;
                    flashlightStream = null;
                } catch (e) {
                    console.error('Error turning off flashlight:', e);
                }
                return;
            }

            // Zaklamp aan zetten
            try {
                // Try with explicit torch constraint
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        advanced: [{ torch: true }]
                    }
                });
                
                flashlightStream = stream;
                flashlightTrack = stream.getVideoTracks()[0];
                
            } catch (e) {
                // Fallback: probeer zonder torch constraint, dan apply constraint
                console.log('Trying alternative method for flashlight...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                
                if (capabilities.torch) {
                    try {
                        await track.applyConstraints({ advanced: [{ torch: true }] });
                        flashlightStream = stream;
                        flashlightTrack = track;
                    } catch (constraintErr) {
                        track.stop();
                        stream.getTracks().forEach(t => t.stop());
                        alert('Zaklamp kan niet worden ingeschakeld op dit apparaat.');
                        return;
                    }
                } else {
                    track.stop();
                    stream.getTracks().forEach(t => t.stop());
                    alert('Zaklamp niet beschikbaar op dit apparaat.');
                    return;
                }
            }
            
        } catch (error) {
            console.error('Zaklamp fout:', error);
            // Probeer graceful fallback
            if (error.name === 'NotAllowedError') {
                alert('Zaklamp toestemming geweigerd. Zet dit in je instellingen aan.');
            } else if (error.name === 'NotFoundError') {
                alert('Camera niet gevonden op dit apparaat.');
            } else {
                alert('Kan de zaklamp niet inschakelen. Mogelijke oorzaken: geen camera, geen toestemming, of onvoldoende Android versie (minimaal Android 5).');
            }
        }
    }
</script>
</body>
</html>