<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Noodhulp App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="top-nav">
    <div class="nav-left">
        <select id="languageSelect" class="btn-lang" onchange="changeLanguage(this.value)">
            <option value="nl">ğŸ‡³ğŸ‡±</option>
            <option value="en">ğŸ‡¬ğŸ‡§</option>
        </select>
        <a href="quiz.html" class="btn-top btn-trainen" data-i18n="train">Trainen</a>
    </div>
    <img src="images/logo.png" alt="Noodhulp App Logo" class="app-logo">
    <div class="nav-right">
        <a href="tel:112" class="btn-top btn-112" data-i18n="call112">ğŸ“ 112</a>
        <button class="info-btn" onclick="showInfo()" data-i18n="info">â„¹ï¸</button>
    </div>
</nav>

<nav class="bottom-nav">
    <a href="index.html" class="btn-top nav-item">
        <span class="nav-icon">ğŸ </span>
        <span class="nav-text">Home</span>
    </a>

    <button class="icon-btn nav-item" onclick="toggleFlashlight()">
        <span class="nav-icon">ğŸ”¦</span>
        <span class="nav-text" data-i18n="flashlight">Zaklamp</span>
    </button>

    <a href="kaart.html" class="btn-top nav-item">
        <span class="nav-icon">ğŸ—ºï¸</span>
        <span class="nav-text" data-i18n="aedmap">AED Kaart</span>
    </a>

    <button class="icon-btn nav-item" onclick="toggleDarkMode()">
        <span class="nav-icon">ğŸŒ“</span>
        <span class="nav-text" data-i18n="darkmode">Donker</span>
    </button>

    <button class="btn-top nav-item" onclick="openProfilePanel()">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-text" data-i18n="mydata">Mijn Gegevens</span>    
    </button>
</nav>

<!-- profielpaneel -->
<div id="profile-panel" class="profile-panel" aria-hidden="true">
    <div class="panel-header">
        <h2 data-i18n="mydata">Mijn Gegevens</h2>
        <button class="close-btn" onclick="closeProfilePanel()" aria-label="Sluiten">âœ–ï¸</button>
    </div>
    <div class="panel-body">
        <label data-i18n="name">Naam
            <input id="profile-name" type="text">
        </label>
        <label data-i18n="address">Adres
            <input id="profile-address" type="text">
        </label>
        <label data-i18n="allergies">AllergieÃ«n
            <input id="profile-allergies" type="text">
        </label>
        <label data-i18n="blood">Bloedgroep
            <input id="profile-blood" type="text">
        </label>
    </div>
</div>

<main class="main-content">
    <section class="hero-actions">
        <a href="slachtoffer.html" class="card card-victim">
            <span class="card-icon">ğŸ©¹</span>
            <div class="card-text">
                <h2 data-i18n="victim">Slachtofferhulp</h2>
                <p data-i18n="victim_p">Eerste hulp verlenen</p>
            </div>
        </a>
        <a href="coÃ¶rdineren-hulp.html" class="card card-coord">
            <span class="card-icon">ğŸ“£</span>
            <div class="card-text">
                <h2 data-i18n="coord">CoÃ¶rdineren</h2>
                <p data-i18n="coord_p">Leid de hulpverlening</p>
            </div>
        </a>
        <div class="card card-location">
            <span class="card-icon">ğŸ“</span>
            <div class="card-text">
                <h2 data-i18n="mylocation">Mijn Locatie</h2>
                <p id="location-status" data-i18n="loc_fetching">Locatie ophalen...</p>
                <div id="location-details" style="font-size: 0.9rem; margin-top: 8px; color: #666;"></div>
            </div>
        </div>
        <a href="quiz.html" class="card card-quiz">
            <span class="card-icon">â“</span>
            <div class="card-text">
                <h2 data-i18n="quiz">Trainen</h2>
                <p data-i18n="quiz_p">Test je kennis</p>
            </div>
        </a>
        <a href="ehbo-gids.html" class="card card-guide">
            <span class="card-icon">ğŸ“–</span>
            <div class="card-text">
                <h2 data-i18n="guide">EHBO Gids</h2>
                <p data-i18n="guide_p">Hulpverlening stap voor stap</p>
            </div>
        </a>
        <a href="kaart.html" class="card card-map">
            <span class="card-icon">ğŸ—ºï¸</span>
            <div class="card-text">
                <h2 data-i18n="aedmap">AED Kaart</h2>
                <p data-i18n="aed_p">Vind een AED in de buurt</p>
            </div>
        </a>
    </section>
</main>

<script>
    // Locatie functionaliteit
    async function getReverseGeocode(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
            const data = await response.json();
            return data.address;
        } catch (error) {
            console.error('Reverse geocoding error:', error);
            return null;
        }
    }
    
    // Huidige taal en vertalingen
    let currentLang = localStorage.getItem('language') || 'nl';

    const translations = {
    nl: {
        train: 'Trainen',
        call112: 'ğŸ“ 112',
        home: 'Home',
        flashlight: 'Zaklamp',
        darkmode: 'Donker',
        aedmap: 'AED Kaart',
        victim: 'Slachtofferhulp',
        victim_p: 'Eerste hulp verlenen',
        coord: 'CoÃ¶rdineren',
        coord_p: 'Leid de hulpverlening',
        mylocation: 'Mijn Locatie',
        loc_fetching: 'Locatie ophalen...',
        loc_found: 'âœ“ Locatie gevonden',
        loc_unavailable: 'âœ— Locatie niet beschikbaar',
        loc_not_supported: 'Geolocation niet ondersteund',
        loc_permission: 'Geef toestemming voor locatie toegang',
        quiz: 'Trainen',
        quiz_p: 'Test je kennis',
        guide: 'EHBO Gids',
        guide_p: 'Hulpverlening stap voor stap',
        aed_p: 'Vind een AED in de buurt',

        /* NIEUW */
        mydata: 'Mijn Gegevens',
        name: 'Naam',
        address: 'Adres',
        allergies: 'AllergieÃ«n',
        blood: 'Bloedgroep',
        close: 'Sluiten',

        infoTitle: 'Noodhulp App â€” versie 1.2.14',
        infoBody: 'Update 1.2.14\n\nToegevoegd:\n- Talenfunctie (Nederlands & Engels)\n\nVerbeteringen:\n- Snellere laadtijden\n- Betere navigatie\n\nBugfixes:\n- Kleine stabiliteitsverbeteringen',
        info: 'â„¹ï¸'
    },

    en: {
        train: 'Training',
        call112: 'ğŸ“ 112',
        home: 'Home',
        flashlight: 'Flashlight',
        darkmode: 'Dark mode',
        aedmap: 'AED Map',
        victim: 'Victim Aid',
        victim_p: 'Provide first aid',
        coord: 'Coordinate',
        coord_p: 'Lead the response',
        mylocation: 'My Location',
        loc_fetching: 'Getting location...',
        loc_found: 'âœ“ Location found',
        loc_unavailable: 'âœ— Location unavailable',
        loc_not_supported: 'Geolocation not supported',
        loc_permission: 'Allow location access',
        quiz: 'Train',
        quiz_p: 'Test your knowledge',
        guide: 'First Aid Guide',
        guide_p: 'Step-by-step assistance',
        aed_p: 'Find an AED nearby',

        /* NIEUW */
        mydata: 'My Information',
        name: 'Name',
        address: 'Address',
        allergies: 'Allergies',
        blood: 'Blood Type',
        close: 'Close',

        infoTitle: 'Emergency App â€” v1.2.14',
        infoBody: 'Update 1.2.14\n\nAdded:\n- Language support (Dutch & English)\n\nImprovements:\n- Faster loading\n- Improved navigation\n\nBug fixes:\n- Minor stability improvements',
        info: 'â„¹ï¸'
    }
};

    function applyTranslations(lang) {
        const map = translations[lang] || translations['nl'];
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (map[key]) {
                el.textContent = map[key];
            }
        });
    }

    function requestLocationPermission() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Update de locatie informatie
                    document.getElementById('location-status').textContent = (translations[currentLang] && translations[currentLang]['loc_found']) ? translations[currentLang]['loc_found'] : 'âœ“ Locatie gevonden';
                    document.getElementById('location-details').innerHTML = (translations[currentLang] && translations[currentLang]['loc_fetching']) ? translations[currentLang]['loc_fetching'] : 'Adres ophalen...';
                    
                    // Haal adres informatie op
                    const address = await getReverseGeocode(lat, lon);
                    
                    if (address) {
                        const street = address.road || address.footway || '';
                        const houseNumber = address.house_number || '';
                        const city = address.city || address.town || address.village || '';
                        
                        let addressLine = '';
                        if (street && houseNumber) {
                            addressLine = `${street} ${houseNumber}`;
                        } else if (street) {
                            addressLine = street;
                        }
                        
                        document.getElementById('location-details').innerHTML = 
                            `${addressLine}<br>${city}`;
                    } else {
                        document.getElementById('location-details').innerHTML = 
                            `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    }
                },
                function(error) {
                    document.getElementById('location-status').textContent = (translations[currentLang] && translations[currentLang]['loc_unavailable']) ? translations[currentLang]['loc_unavailable'] : 'âœ— Locatie niet beschikbaar';
                    document.getElementById('location-details').textContent = (translations[currentLang] && translations[currentLang]['loc_permission']) ? translations[currentLang]['loc_permission'] : 'Geef toestemming voor locatie toegang';
                }
            );
        } else {
                document.getElementById('location-status').textContent = (translations[currentLang] && translations[currentLang]['loc_not_supported']) ? translations[currentLang]['loc_not_supported'] : 'Geolocation niet ondersteund';
        }
    }
    
    // Vraag om locatie toestemming wanneer de pagina laadt
    window.addEventListener('load', function() {
        requestLocationPermission();
    });
    
    // Herstel dark mode instellingen
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
    if (localStorage.getItem('flashlight') === 'true') {
        document.body.style.filter = 'invert(1)';
    }

    // Herstel taal voorkeur en pas vertalingen toe
    const savedLang = localStorage.getItem('language') || currentLang;
    currentLang = savedLang;
    applyTranslations(currentLang);
    window.addEventListener('load', function() {
        const langSelect = document.getElementById('languageSelect');
        if (langSelect) langSelect.value = currentLang;
    });

    function changeLanguage(code) {
        localStorage.setItem('language', code);
        currentLang = code;
        applyTranslations(code);
    }

    function showInfo() {
        const map = translations[currentLang] || translations['nl'];
        alert(map.infoTitle + "\n" + map.infoBody);
    }

    // --- profiel panel scripts ---
    function openProfilePanel() {
        document.getElementById('profile-panel').classList.add('open');
    }

    function closeProfilePanel() {
        document.getElementById('profile-panel').classList.remove('open');
    }

    function loadProfile() {
        const data = JSON.parse(localStorage.getItem('profile') || '{}');
        document.getElementById('profile-name').value = data.name || '';
        document.getElementById('profile-address').value = data.address || '';
        document.getElementById('profile-allergies').value = data.allergies || '';
        document.getElementById('profile-blood').value = data.blood || '';
    }

    function saveProfile() {
        const data = {
            name: document.getElementById('profile-name').value,
            address: document.getElementById('profile-address').value,
            allergies: document.getElementById('profile-allergies').value,
            blood: document.getElementById('profile-blood').value
        };
        localStorage.setItem('profile', JSON.stringify(data));
    }

    window.addEventListener('DOMContentLoaded', function() {
        if (typeof loadProfile === 'function') {
            loadProfile();
            const inputs = document.querySelectorAll('#profile-panel input');
            inputs.forEach(i => i.addEventListener('input', saveProfile));
        }
    });

    function toggleDarkMode() { 
        document.body.classList.toggle("dark-mode");
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }
    
    // Zaklamp variabele
    let flashlightStream = null;
    let flashlightTrack = null;
    
    async function toggleFlashlight() { 
        try {
            // Check browser support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Zaklamp niet ondersteund op deze browser.');
                return;
            }

            // Als zaklamp al aan staat, zet uit
            if (flashlightTrack) {
                try {
                    await flashlightTrack.applyConstraints({ advanced: [{ torch: false }] });
                    flashlightTrack.stop();
                    flashlightStream.getTracks().forEach(track => track.stop());
                    flashlightTrack = null;
                    flashlightStream = null;
                } catch (e) {
                    console.error('Error turning off flashlight:', e);
                }
                return;
            }

            // Zaklamp aan zetten
            try {
                // Try with explicit torch constraint
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        advanced: [{ torch: true }]
                    }
                });
                
                flashlightStream = stream;
                flashlightTrack = stream.getVideoTracks()[0];
                
            } catch (e) {
                // Fallback: probeer zonder torch constraint, dan apply constraint
                console.log('Trying alternative method for flashlight...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                
                if (capabilities.torch) {
                    try {
                        await track.applyConstraints({ advanced: [{ torch: true }] });
                        flashlightStream = stream;
                        flashlightTrack = track;
                    } catch (constraintErr) {
                        track.stop();
                        stream.getTracks().forEach(t => t.stop());
                        alert('Zaklamp kan niet worden ingeschakeld op dit apparaat.');
                        return;
                    }
                } else {
                    track.stop();
                    stream.getTracks().forEach(t => t.stop());
                    alert('Zaklamp niet beschikbaar op dit apparaat.');
                    return;
                }
            }
            
        } catch (error) {
            console.error('Zaklamp fout:', error);
            // Probeer graceful fallback
            if (error.name === 'NotAllowedError') {
                alert('Zaklamp toestemming geweigerd. Zet dit in je instellingen aan.');
            } else if (error.name === 'NotFoundError') {
                alert('Camera niet gevonden op dit apparaat.');
            } else {
                alert('Kan de zaklamp niet inschakelen. Mogelijke oorzaken: geen camera, geen toestemming, of onvoldoende Android versie (minimaal Android 5).');
            }
        }
    }
</script>
</body>
</html>