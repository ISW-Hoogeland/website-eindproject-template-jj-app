<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Noodhulp App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="top-nav">
    <a href="quiz.html" class="btn-top btn-trainen">Trainen</a>
    <img src="images/logo.png" alt="Noodhulp App Logo" class="app-logo">
    <a href="tel:112" class="btn-top btn-112">ğŸ“ 112</a>
</nav>

<nav class="bottom-nav">
    <a href="index.html" class="btn-top nav-item active"><span>ğŸ </span>Home</a>
    <button class="icon-btn" onclick="toggleFlashlight()">ğŸ”¦</button>
    <button class="icon-btn" onclick="toggleDarkMode()">ğŸŒ“</button>
    <a href="kaart.html" class="btn-top nav-item"><span>ğŸ—ºï¸</span>AED Kaart</a>
</nav>

<main class="main-content">
    <section class="hero-actions">
        <a href="slachtoffer.html" class="card card-victim">
            <span class="card-icon">ğŸ©¹</span>
            <div class="card-text">
                <h2>Slachtofferhulp</h2>
                <p>Eerste hulp verlenen</p>
            </div>
        </a>
        <a href="coÃ¶rdineren-hulp.html" class="card card-coord">
            <span class="card-icon">ğŸ“£</span>
            <div class="card-text">
                <h2>CoÃ¶rdineren</h2>
                <p>Leid de hulpverlening</p>
            </div>
        </a>
        <div class="card card-location">
            <span class="card-icon">ğŸ“</span>
            <div class="card-text">
                <h2>Mijn Locatie</h2>
                <p id="location-status">Locatie ophalen...</p>
                <div id="location-details" style="font-size: 0.9rem; margin-top: 8px; color: #666;"></div>
            </div>
        </div>
        <a href="quiz.html" class="card card-quiz">
            <span class="card-icon">â“</span>
            <div class="card-text">
                <h2>Trainen</h2>
                <p>Test je kennis</p>
            </div>
        </a>
        <a href="ehbo-gids.html" class="card card-guide">
            <span class="card-icon">ğŸ“–</span>
            <div class="card-text">
                <h2>EHBO Gids</h2>
                <p>Hulpverlening stap voor stap</p>
            </div>
        </a>
        <a href="kaart.html" class="card card-map">
            <span class="card-icon">ğŸ—ºï¸</span>
            <div class="card-text">
                <h2>AED Kaart</h2>
                <p>Vind een AED in de buurt</p>
            </div>
        </a>
    </section>
</main>

<script>
    // Locatie functionaliteit
    async function getReverseGeocode(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
            const data = await response.json();
            return data.address;
        } catch (error) {
            console.error('Reverse geocoding error:', error);
            return null;
        }
    }
    
    function requestLocationPermission() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Update de locatie informatie
                    document.getElementById('location-status').textContent = 'âœ“ Locatie gevonden';
                    document.getElementById('location-details').innerHTML = 'Adres ophalen...';
                    
                    // Haal adres informatie op
                    const address = await getReverseGeocode(lat, lon);
                    
                    if (address) {
                        const street = address.road || address.footway || '';
                        const houseNumber = address.house_number || '';
                        const city = address.city || address.town || address.village || '';
                        
                        let addressLine = '';
                        if (street && houseNumber) {
                            addressLine = `${street} ${houseNumber}`;
                        } else if (street) {
                            addressLine = street;
                        }
                        
                        document.getElementById('location-details').innerHTML = 
                            `${addressLine}<br>${city}`;
                    } else {
                        document.getElementById('location-details').innerHTML = 
                            `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    }
                },
                function(error) {
                    document.getElementById('location-status').textContent = 'âœ— Locatie niet beschikbaar';
                    document.getElementById('location-details').textContent = 'Geef toestemming voor locatie toegang';
                }
            );
        } else {
            document.getElementById('location-status').textContent = 'Geolocation niet ondersteund';
        }
    }
    
    // Vraag om locatie toestemming wanneer de pagina laadt
    window.addEventListener('load', function() {
        requestLocationPermission();
    });
    
    // Herstel dark mode instellingen
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
    if (localStorage.getItem('flashlight') === 'true') {
        document.body.style.filter = 'invert(1)';
    }
    
    function toggleDarkMode() { 
        document.body.classList.toggle("dark-mode");
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }
    
    // Zaklamp variabele
    let flashlightStream = null;
    let flashlightTrack = null;
    
    async function toggleFlashlight() { 
        try {
            // Check browser support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Zaklamp niet ondersteund op deze browser.');
                return;
            }

            // Als zaklamp al aan staat, zet uit
            if (flashlightTrack) {
                try {
                    await flashlightTrack.applyConstraints({ advanced: [{ torch: false }] });
                    flashlightTrack.stop();
                    flashlightStream.getTracks().forEach(track => track.stop());
                    flashlightTrack = null;
                    flashlightStream = null;
                } catch (e) {
                    console.error('Error turning off flashlight:', e);
                }
                return;
            }

            // Zaklamp aan zetten
            try {
                // Try with explicit torch constraint
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        advanced: [{ torch: true }]
                    }
                });
                
                flashlightStream = stream;
                flashlightTrack = stream.getVideoTracks()[0];
                
            } catch (e) {
                // Fallback: probeer zonder torch constraint, dan apply constraint
                console.log('Trying alternative method for flashlight...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                
                if (capabilities.torch) {
                    try {
                        await track.applyConstraints({ advanced: [{ torch: true }] });
                        flashlightStream = stream;
                        flashlightTrack = track;
                    } catch (constraintErr) {
                        track.stop();
                        stream.getTracks().forEach(t => t.stop());
                        alert('Zaklamp kan niet worden ingeschakeld op dit apparaat.');
                        return;
                    }
                } else {
                    track.stop();
                    stream.getTracks().forEach(t => t.stop());
                    alert('Zaklamp niet beschikbaar op dit apparaat.');
                    return;
                }
            }
            
        } catch (error) {
            console.error('Zaklamp fout:', error);
            // Probeer graceful fallback
            if (error.name === 'NotAllowedError') {
                alert('Zaklamp toestemming geweigerd. Zet dit in je instellingen aan.');
            } else if (error.name === 'NotFoundError') {
                alert('Camera niet gevonden op dit apparaat.');
            } else {
                alert('Kan de zaklamp niet inschakelen. Mogelijke oorzaken: geen camera, geen toestemming, of onvoldoende Android versie (minimaal Android 5).');
            }
        }
    }
</script>
</body>
</html>